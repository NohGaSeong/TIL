# VPC 와 중계 서버(Bastion) 구성하기

## 아키텍처에 구현할 기술
가상의 네트워크에서 인터넷과 연결 또는 연결되지 않는 하위 네트워크를 만들고 다른 가상 서버와 연결하기 위한 중계 서버를 구성합니다.

## 필요 AWS 서비스
- Amazon EC2
- Amazon Virtual Private Cloud(VPC)

## 기타 필요사항
- CIDR
- Subnetting

## 아키텍쳐 구현 순서
1. Custom VPC-Subnet 생성하기
   (1) VPC : CIDR 10.0.0.0/16
   (2) Subnet(Public/Private) 생성하기
   - PUblic 10.0.1.0/24, 10.0.2.0/24
   - Private 10.0.3.0/24, 10.0.4.0/24
   - Private 10.0.5.0/24, 10.0.6.0/24

2. Internet Gateway-Routing Table 설정하기
   (1) Internet Gateway 만들기
   (2) Routing table-Public 만들기
   (3) Routing table-Private 만들기
   (4) Public subnet에 Routing table-Public 연결
   (5) Private subnet에 Routing table-Private 연결

3. NAT Gateway 구성하기
   (1) NAT Gateway 만들기
   (2) Route table에 NAT Gateway 업데이트
   (3) NAT Gateway 테스트

4. Bastion Host 생성하기
   (1) Bastion Host 생성하기
   (2) Key Pari(xxx.pem) 복사하기
   (3) Bastion Host에 접속하고 Private subnet의 EC2에 접속하기

## VPC 및 Public/Private Subnet 생성

`EC2에서 vpc를 생성하고 CIDR과 서브넷 인터넷 게이트웨이 , 나트웨이트웨이 등을 구성하는 실습을 시작해보도록 하겠습니다.`

### VPC
AWS에 들어가 vpc를 검색하시면 왼쪽에 여러 항목들이 보일텐데요 이 중에 VPC, 서브넷 , 라우팅 테이블, 인터넷 게이트웨이, NAT 게이트웨이. 이렇게 순차적으로 진행해볼게요.

우선 VPC를 선택해줍시다.

들어가면 만든적도 없는데 VPC가 하나 있을거에요. 이거는 Default VPC 라서 내비두고 하나 생성해줍시다. VPC 생성을 눌러주세요.

이름 태그 : `lab-vpc`<br>
Ipv4 CIDR 블록 _ `서브넷 이상으로 가장 큰 아이피 범위를 선언하는 칸`<br>
    :10.0.0.0/16

나머지는 기본값으로 설정해주세요. <br>
![Alt text](VPC_NAT/n1.png)<br>
짠 ~ 잘 만들어졌죠? 그러면 이제 서브넷을 생성할건데요 서브넷은 총 6개 , 퍼블릭 2개 , 프라이빗 4개를 생성할거에요. 왼쪽 메뉴에서 서브넷을 선택해주세요

### 서브넷
우선 서브넷을 만들어야겠죠? 서브넷 생성을 눌러주세요 

VPC ID : 아까만들었던 `lab-vpc` 로 선택해주세요<br>
서브넷 이름 : `lab-web-pub1-2a`<br>
가용영역 : 이름을 따라 2a 로 지정해주세요<br>
IPv4 CIDR 블록 _ 10.0.1.0/24<br>
    : 이렇게되면 251 개의 아이피를 사용할 수 있는 범위가 돼요!

이렇게 2a를 만들어줬으면 2a 를 2c로 바꾸고 IPv4 CIDR 블록도 10.0.2.0/24 로 수정한 `lab-web-pub2-2c` 도 만들어주세요!

![Alt text](VPC_NAT/n2.png)

이렇게해서 Public 2개가 만들어졌어요. 이제 public 2개를 만들었으니까 private 4개도 만들어야겠죠?

아까 2a 를 만든 설정과 똑같이해주시고 이름은 `lab-web-pri1-2a` 로, IPv4 CIDR 블록은 3번째니까 10.0.3.0/24 로 바꿔 만들어주세요.

그 다음 2c는 어떤식으로 만들어야할지 알겠죠?

이렇게 Private 4개를 마저 만들어서 Public 서브넷 2개, Private 4개를 만들어주시면돼요.

![Alt text](VPC_NAT/n3.png)

## Internet Gateway 및 Route Table 구성

인터넷 게이트웨이와 라우트 테이블을 설정해서 두 개의 Public 서브넷은 Public 용으로 구성을 하고 4개의 Private 서브넷은 Private 용으로 구성을 하는 라우팅 작업까지 해보도록해요!

### Internet Gateway
인터넷 게이트웨이를 클릭해주시고 인터넷 게이트웨이 생성을 눌러주세요!

이름태그 : `lab-web-igw` 로 설정을 해주시고 인터넷 게이트웨이를 생성해주세요.

만든 인터넷 게이트웨이가 어느 VPC에 트래픽을 연결해줄것이냐를 설정해주셔야해요.

만든 인터넷 게이트웨이를 클릭하시고 오른쪽 위 작업을 누르셔서 VPC에 연결을 클릭해주세요. 

그리고 저희가 만들었던 vpc를 선택해주시고 vpc 연결을 눌러주시면돼요. 쉽죠?


### Route Table
라우팅 테이블은 Private용 , Public용. 이렇게 2개를 만들어줄거에요. 왼쪽 메뉴에 라우팅 테이블을 들어가면 라우팅 테이블이 하나 만들어져 있을건데 이건 저희가 VPC 를 만들게 되면 따라나오는 번들용 라우팅 테이블이라고 이해하시면돼요. 이걸 활용해서 public 으로 만들고 private는 새로 만들어줄거에요.

먼저 만들어져있는 라우팅 테이블의 네임 태그는 `lab-web-rt-pub` 로 변경을 해줄게요.

라우트가 있어요.밑에 하단에 로컬로 지금 되어있는데 이 로컬은 비활성홛 되어있는거고 퍼블릭용이니까 인터넷 게이트웨이르 통해 인터넷으로 트래픽이 나가도록 라우트를 넣어줘야해요. 라우팅 편집을 누르고 라우팅 추가를 눌러줘요.


대상 : 모든 ip 어드레스는 타겟으로 가라고 명시를 해주는건데요 모든 인터넷을 표현하는것은 `0.0.0.0/0` 입니당.   

2번째 대상 : 인터넷 게이트웨이를 선택해주시고 저희가 만든 인터넷 게이트웨이를 선택해주시면돼요.

![Alt text](VPC_NAT/n4.png)<br>
이렇게 입력을 하셨으면 저장해주세요.

이제 라우팅 테이블을 타고 나갈 서브넷을 선택해야하는데 라우팅 옆에 서브넷 연결 -> 서브넷 연결 편집을 눌러 저희가 만들었는 퍼블릭 서브넷 2개를 선택해주세요.

![Alt text](VPC_NAT/n5.png)
이렇게 지정을 해주셨으면 이제 프라이빗 라우팅 테이블도 만들어야겠죠?

라우팅 테이블 생성을 눌러 프라이빗 라우팅 테이블을 만들어주세요.
이름 : `lab-web-rt-pri`
VPC : 빈칸을 눌러서 `lab VPC`를 선택해주세요.

이후 퍼블릭 서브넷을 연결했던것처럼 똑같이 프라이빗 서브넷 4개를 연결시켜주세요.

## NAT Gateway 구성

vpc에 프라이빗 서브넷에 있는 aws 리소스가 인터넷에서 트래픽이 통할 수 있게 해주는 서비스입니다. 2개를 만들거고 2a용과 2c 용으로 만들거에요.

왜 2개를 만드냐? : 그 서브넷에서에 대한 나트 기능을 주로 하기 때문에 다른 서브넷의 영역은 침범하지 않아요. 

그래서 2a, 2c에 나트를 하나씩 올리고 프라이빗 라우팅 테이블도 나트 덕에 하나 더 만들거에요.

### Nat Gateway   

왼쪽 메뉴에 나트 게이트웨이를 클릭하시고 나트 게이트웨이 생성을 눌러주세요.

이름 : `lab-web-nat-2a`
서브넷 : 2a 용이니까 `pub-2a` 를 선택해주세요.
탄력적 IP 할당 ID : 탈력적 IP 할당을 눌러서 할당을 받아주세요.

이렇게 설정을 마치고 NAT 게이트웨이를 생성해주세요.

2a 를 만들었으니까 2c 도 만들어야겠죠? 2c 도 똑같은 방식으로 만들어주세요.
![Alt text](VPC_NAT/n6.png)<br>
이렇게 2개를 만들었으면 아까 말한대로 프라이빗 라우팅 테이블도 하나 더 만들어야겠죠?

우선 아까만든 private 라우팅 테이블의 이름을 `-2a` 를 넣어 수정해주시고 2a 를 제외한 서브넷을 빼주세요.
![Alt text](VPC_NAT/n7.png)<br>
이렇게요! 그리고 이제 저희가 2a 라우팅 테이블을 만든 것처럼 하나 만들어주세요.

이렇게 프라이빗 용으로 라우팅 테이블을 2개 만드는 이유는 특정한 가용영역에 장애가 나면 한쪽은 정상적으로 서비스가 되어야되기 때문에 이렇게 2개를 둬서 트래픽이 흐르도록 구성하는겁니다.

![Alt text](VPC_NAT/n8.png)<br>

이제 다시 나트게이트웨이를 가서 확인을 해보시면
![Alt text](VPC_NAT/n9.png)<br>
짠 잘 됐죠?

## Bastion 및 NAT Gateway를 통한 Private 영역 EC2의 외부 인터넷 통신
이제 Bastion 생성하고 퍼블릭서브넷 영역에 배치하고 프라이빗 서브넷에 ec2 생성해서 Bastion 에서 프라이빗 영역에 있는 ec2에 ssh 로그인하는 부분을 패스할거고 프라이빗 서브넷에 있는 ec2에서 외부로 통신하기 위해 nat 와 어떤 연관이 있는지 , 연동이 있는지 테스트해보도록 하겠습니다.

Bastion 먼저 생성해봅시다. EC2를 들어가주세요 예전에 만든 커스텀 AMI 가 있죠? 어플리케이션과 구성들이 다 수정이 된 상황에서 AMI 를 만들었기 때문에 그 AMI를 사용해서 Bastion 을 퍼블릭 영역에 설정해볼게요

왼쪽의 AMI 를 누르고 저번에 만들었던 AMI 를 클릭하고 시작하기를 눌러주세요. 그러면 ec2 생성이랑 같게 될건데 

프리티어를 선택해주시고 
인스턴스 세부 구성은

네트워크 : 우리가 만든 VPC
서브넷 : pub 2a
퍼블릭 IP 자동 할당 : 활성화

나머지 설정은 기본값으로 놔둬주세요.

이미 내부구성이 다 진행된 AMI 이기 때문에 유저 데이터에 스크립트를 넣어줄 필요가 없어요.

태그
key : Name
value : lab-web-srv-bastion

보안그룹은 새로 하나 만들어주세요
lab-web-bastion-sg

키페어도 bastion 용 키페어를 하나 만들어주세요. 그리고 인스턴스 시작.

프라이빗 서브넷에 ec2도 바로 하나 만들어줄게요 다른거 다 똑같이해주고 2c로 설정, 벨류는 lab-web-srv-pri-2c 로 지정해줄게요.
그리고 보안그룹도 따로 만들어주세요. `lab-web-srv-sg` 키페어도 하나 만듭시다. `seoul-lab-web-srv`

puttygen을 켜주시고 bastion과 웹서버용 pem 을 ppk 로 변환시켜주세요. bastion 에 먼저 로그인해줍시다.

public ip 를 복사하고 붙여놓고 , ppk를 선택해서 로그인 창을 띄워주도록합시다.

로그인은 저번과 같이 `ec2-user` 을 입력해주면 로그인이됩니다.

이제 프라이빗 서브넷에 있는 ec2의 pem 을 복사해야와야하는데 메모장을 활용해서 진행할게요. pem 파일을 메모장으로 여신 다음 컨트롤 A + 컨트롤 C 를 누르시고 푸티 화면에서

`sudo vi '파일명.pem'`

엔터를 눌러 리눅스 편집기로 들어가줍니다. 이후 insert 모드를 위해 i 를 눌러주시고 우클릭을 눌러 pem 파일에서 긁은 내용을 붙여넣어줍시다. 긁은 내용에서 아무것도 건들이지마시고 그대로 ESC -> :wq 를 입력해 저장하고 나가주도록합시다.

ls 라는 명령어를 치면 pem 이 잘 뜰거에요. 이제 연결해봅시다.

`ssh -i 'pem 이름.pem' ec2-user@'private ip'`

하면 yes or no 가 뜨는데 연결시켜줄려면 yes를 해야겟죠?

잘 연결됐는지 확인해주기 위해 `ping google.co.kr` 을 입력해줍시다. 이때 안될 수도 있는데 나트를 타고 나가라는 라우팅이 추가가 안돼서 그래요

vpc 를 누르고 라우팅 테이블로 이동하시고 2a 를 눌러 외부로 나갈때 나트를 타고 나가라는 라우트를 추가해줘야합니다. 

Destination: 0.0.0.0/0
target : nat 2a,

저장해주시면 잘 추가되어있습니다. 다시 푸티로 가서 ping 명령어를 입력해주면 이제 잘 연결이 되는 것을 볼 수 있습니다.

## 글을 마치며
쉬워서 텍스트만 봐도 따라갈 수 있는 것은 텍스트로만 설명하기로했어요. 처음부터 끝까지 사진을 첨부하면 좋겠지만 힘든 것도 있고 너무 스크롤이 길어져서? 간단한건 간단하게 알려주는게 좋을 것 같애요. 히히 ++ 그것보다 너무 양이 많아요... 따라가면서 힘들었음 ㅠ
